apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: product-catalog
resources:
  - ../../base
  - networkpolicy.yaml
  - priorityclass.yaml
commonLabels:
  environment: "production"
  managed-by: kustomize
commonAnnotations:
  environment.type: "production"
  description: "Production environment - strict resource limits and security"
images:
  - name: product-catalog
    newName: 692298411961.dkr.ecr.us-east-1.amazonaws.com/base-infrastructure-dev-app
    newTag: latest
patches:
  - target:
      kind: Deployment
      name: product-catalog
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: product-catalog
        namespace: product-catalog
      spec:
        replicas: 3
        template:
          spec:
            containers:
              - name: product-catalog
                resources:
                  requests:
                    cpu: "500m"
                    memory: "768Mi"
                  limits:
                    cpu: "1500m"
                    memory: "1024Mi"
                livenessProbe:
                  httpGet:
                    path: /actuator/health/liveness
                    port: 8087
                    scheme: HTTP
                  initialDelaySeconds: 90
                  periodSeconds: 10
                  timeoutSeconds: 5
                  successThreshold: 1
                  failureThreshold: 5
                readinessProbe:
                  httpGet:
                    path: /actuator/health/readiness
                    port: 8087
                    scheme: HTTP
                  initialDelaySeconds: 45
                  periodSeconds: 5
                  timeoutSeconds: 3
                  successThreshold: 1
                  failureThreshold: 3
                startupProbe:
                  httpGet:
                    path: /actuator/health
                    port: 8087
                    scheme: HTTP
                  initialDelaySeconds: 10
                  periodSeconds: 5
                  timeoutSeconds: 3
                  successThreshold: 1
                  failureThreshold: 40
  - target:
      kind: HorizontalPodAutoscaler
      name: product-catalog-hpa
    patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: product-catalog-hpa
        namespace: product-catalog
      spec:
        minReplicas: 3
        maxReplicas: 10
  - target:
      kind: PodDisruptionBudget
      name: product-catalog-pdb
    patch: |-
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: product-catalog-pdb
        namespace: product-catalog
      spec:
        minAvailable: 2
  - target:
      kind: ConfigMap
      name: product-catalog-config
    patch: |-
      - op: replace
        path: /data/LOGGING_LEVEL_ROOT
        value: WARN
      - op: replace
        path: /data/LOGGING_LEVEL_COM_PRODUCT_CATALOG
        value: INFO
      - op: replace
        path: /data/LOGGING_LEVEL_ORG_HIBERNATE_SQL
        value: WARN
      - op: replace
        path: /data/SPRING_JPA_SHOW_SQL
        value: "false"
