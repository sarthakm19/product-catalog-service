  apiVersion: kustomize.config.k8s.io/v1beta1
  kind: Kustomization

  namespace: product-catalog-dev

  resources:
    - ../../base

  images:
    - name: product-catalog
      newTag: dev

  patches:
    # Set replica count and tune deployment resources/probes for dev
    - target:
        kind: Deployment
        name: product-catalog
      patch: |-
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: product-catalog
          namespace: product-catalog-dev
        spec:
          replicas: 1
          template:
            spec:
              containers:
                - name: product-catalog
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "256Mi"
                    limits:
                      cpu: "500m"
                      memory: "512Mi"
                  livenessProbe:
                    httpGet:
                      path: /actuator/health/liveness
                      port: 8087
                      scheme: HTTP
                    initialDelaySeconds: 30
                    periodSeconds: 15
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /actuator/health/readiness
                      port: 8087
                      scheme: HTTP
                    initialDelaySeconds: 15
                    periodSeconds: 5
                    timeoutSeconds: 3
                    successThreshold: 1
                    failureThreshold: 3
                  startupProbe:
                    httpGet:
                      path: /actuator/health
                      port: 8087
                      scheme: HTTP
                    initialDelaySeconds: 10
                    periodSeconds: 5
                    timeoutSeconds: 3
                    successThreshold: 1
                    failureThreshold: 30
    # Loosen HPA thresholds for dev testing
    - target:
        kind: HorizontalPodAutoscaler
        name: product-catalog-hpa
      patch: |-
        apiVersion: autoscaling/v2
        kind: HorizontalPodAutoscaler
        metadata:
          name: product-catalog-hpa
          namespace: product-catalog-dev
        spec:
          minReplicas: 1
          maxReplicas: 3
          metrics:
            - type: Resource
              resource:
                name: cpu
                target:
                  type: Utilization
                  averageUtilization: 70
            - type: Resource
              resource:
                name: memory
                target:
                  type: Utilization
                  averageUtilization: 80
    # Enable verbose logging and SQL show for dev via ConfigMap
    - target:
        kind: ConfigMap
        name: product-catalog-config
      patch: |-
        - op: replace
          path: /data/SPRING_JPA_SHOW_SQL
          value: "true"
        - op: replace
          path: /data/LOGGING_LEVEL_ORG_HIBERNATE_SQL
          value: "DEBUG"
        - op: replace
          path: /data/LOGGING_LEVEL_COM_PRODUCT_CATALOG
          value: "DEBUG"